#include <Wire.h>
#include <Adafruit_BMP3XX.h>

Adafruit_BMP3XX bmp;

#define SEALEVELPRESSURE_HPA (1013.25)

float baselineAltitude = 0;
bool apogeeDetected = false;

void setup() {
  Serial.begin(115200);
  Wire.begin(21, 22);  // SDA = 21, SCL = 22

  if (!bmp.begin_I2C()) {
    Serial.println("BMP3XX not found!");
    while (1);
  }

  bmp.setTemperatureOversampling(BMP3_OVERSAMPLING_8X);
  bmp.setPressureOversampling(BMP3_OVERSAMPLING_4X);
  bmp.setIIRFilterCoeff(BMP3_IIR_FILTER_COEFF_3);

  delay(2000);

  if (bmp.performReading()) {
    baselineAltitude = bmp.readAltitude(SEALEVELPRESSURE_HPA);
  }

  Serial.println("System Ready");
}

void loop() {

  if (!bmp.performReading()) {
    Serial.println("Sensor read failed");
    return;
  }

  float altitude = bmp.readAltitude(SEALEVELPRESSURE_HPA);
  float relativeAltitude = altitude - baselineAltitude;

  Serial.print("Altitude: ");
  Serial.println(relativeAltitude);

  static float lastAltitude = 0;

  if (relativeAltitude < lastAltitude - 2.0 && !apogeeDetected) {
    apogeeDetected = true;
    Serial.println("APOGEE");
    Serial2.println("TRIGGER");  // Send to ESP32-CAM
  }

  lastAltitude = relativeAltitude;

  delay(100);
}
